---
title: "Final version for paper"
author: "Archana Neupane Timsina"
date: "2024-06-28"
output: html_document
---

```{r}
rm(list=ls())
```


```{r}
library("sensobol")
 library("data.table")
 library("ggplot2")
library(plyr)
library(tidyverse)
library(deSolve)
library("foreach")
library("iterators")
 library("parallel")
 library("doParallel")
library("cowplot")
library("extrafont")

```





```{r}
N <-20000
params <-c( "theta","zeta","rho","epsilon","phi","f","alpha_1","alpha_2","alpha_3","beta_1d","beta_2d","beta_3d","beta_1c","beta_2c","beta_3c")

order <- "first"
 R <- 10^3
 #type <- "norm"
 conf <- 0.95
 times <- seq(0, 375, 1)
timeOutput <- seq(5, 375, 5)

meta_cdiff <- function(t, state, parameters) {
 with(as.list(c(state, parameters)), {
          N1 = R1u +S1u+ C1u+ D1u+ R1v+ S1v+C1v+D1v;
          N2 = R2u +S2u+ C2u+ D2u+ R2v+ S2v+C2v+D2v;
          N3 = R3u +S3u+ C3u+ D3u+ R3v+ S3v+C3v+D3v;
         
         d_2N2 = d_2*(R2u +S2u+ C2u+ D2u+ R2v+ S2v+C2v+D2v);
         d_1N1 = d_1*(R1u +S1u+ C1u+ D1u+ R1v+ S1v+C1v+D1v);
         d_3N3 = d_3*(R3u +S3u+ C3u+ D3u+ R3v+ S3v+C3v+D3v);
         
         b = d_1N1 + d_2N2 + d_3N3 ;
         
         m12= (1-N2/K2)*(1-q1)*delta1;
         m21= q2*delta2 + (N3/K3)*(1-q2)*delta2;
         m13= (1-N3/K3)*q1*delta1;
         m31= q3*delta3 + (N2/K2)*(1-q3)*delta3;
         m23= (1-N3/K3)*(1-q2)*delta2;
         m32= (1-N2/K2)*(1-q3)*delta3;
        
         
        dR1u= b-alpha_1*R1u-d_1*R1u+theta*S1u+zeta*C1u+(1-v)*(R2u)*m21+(1-v)*(R3u)*m31- (R1u)*m12  -(R1u)*m13 ;
         
         dS1u= -d_1*S1u -theta*S1u+ alpha_1*R1u + rho* epsilon*D1u-(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u +(1-v)*(S2u)*m21 + (1-v)*(S3u)*m31- (S1u)*m12  -(S1u)*m13;
         
         dC1u= -(d_1+f*phi+zeta)*C1u+(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u+(1-v)*(C2u)*m21+(1-v)*(C3u)*m31- (C1u)*m12  -(C1u)*m13; 
         
         dD1u=-(d_1+rho*epsilon)*D1u+f*phi*C1u +(1-v)*(D2u)*m21+(1-v)*(D3u)*m31- (D1u)*m12 -(D1u)*m13;
         
         dR1v=-(1-g)* alpha_1*R1v - d_1* R1v+ (theta/(1-g))*S1v + (zeta/(1-h))*C1v + (R2v)*m21+(R3v)*m31- (R1v)*m12  -(R1v)*m13 + v*(R2u)*m21+ v*(R3u)*m31;
         
         dS1v= -(d_1+ theta/(1-g))*S1v+(1-g)*alpha_1*R1v+rho*epsilon*D1v-(1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))* S1v + (S2v)*m21+(S3v)*m31- (S1v)*m12  -(S1v)*m13 + v*(S2u)*m21+ v*(S3u)*m31;
         
         dC1v=  -(d_1+(1-eta)*f*phi+(zeta/(1-h)))*C1v+
    (1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1v + (C2v)*m21+(C3v)*m31- (C1v)*m12  -(C1v)*m13 + v*(C2u)*m21+ v*(C3u)*m31;
         
         dD1v= -(d_1 + rho* epsilon)*D1v+(1-eta)*f*phi*C1v + (D2v)*m21+(D3v)*m31- (D1v)*m12  -(D1v)*m13 + v*(D2u)*m21 + v*(D3u)*m31; 
         
    #nursinh home
         
         dR2u= -alpha_2*R2u-d_2*R2u+ theta*S2u + zeta*C2u + (R1u)*m12 + (1-v)*(R3u)*m32- (R2u)*m23 - (R2u)*m21;
         
         dS2u= -(d_2+theta)*S2u+alpha_2*R2u+rho*epsilon*D2u-(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u + (S1u)*m12+(1-v)*(S3u)*m32 -(S2u)*m23 - (S2u)*m21;
         
         dC2u= -(d_2+f*phi+zeta)*C2u+(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u+(C1u)*m12+
           (1-v)*(C3u)*m32- (C2u)*m23 - (C2u)*m21;
         
         dD2u= -(d_2+rho*epsilon)*D2u +f*phi*C2u + (D1u)*m12+(1-v)*(D3u)*m32- (D2u)*m23 - (D2u)*m21;
         
         
         dR2v= -(1-g)*alpha_2*R2v-d_2*R2v+(theta/(1-g))*S2v+(zeta/(1-h))*C2v + (R1v)*m12+(R3v)*m32- (R2v)*m23 - (R2v)*m21 + v*(R3u)*m32; 
         
         dS2v= -(d_2+ theta/(1-g))*S2v +(1-g)* alpha_2*R2v + rho* epsilon*D2v-(1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v +(S1v)*m12+(S3v)*m32- (S2v)*m23 - (S2v)*m21+v*(S3u)*m32; 
         
         dC2v= -(d_2+(1-eta)*f*phi+(zeta/(1-h)))*C2v + (1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v+
           ( C1v)*m12+(C3v)*m32- (C2v)*m23 - (C2v)*m21 +v*(C3u)*m32;  
         
         dD2v= -(d_2 + rho* epsilon)*D2v +(1-eta)*f*phi*C2v + (D1v)*m12+(D3v)*m32- (D2v)*m23 - (D2v)*m21 +v*(D3u)*m32; 
   #hospital  
         
         dR3u= -(d_3  + alpha_3)*R3u +theta*S3u + zeta*C3u + (R1u)*m13 + (1-v)*(R2u)*m23 -(R3u)*m31 - (R3u)*m32;
         
         dS3u= -(d_3  + theta)*S3u + alpha_3*R3u + rho* epsilon*D3u- (beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3u + (S1u)*m13 + (1-v)*(S2u)*m23 -(S3u)*m31 - (S3u)*m32;
         
         dC3u= -(d_3+f*phi+zeta)*C3u+(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))* S3u + (C1u)*m13 + (1-v)*(C2u)*m23 -(C3u)*m31 - (C3u)*m32;
         
         dD3u= -(d_3  +rho* epsilon)*D3u + f*phi*C3u + (D1u)*m13 + (1-v)*(D2u)*m23 -(D3u)*m31 - (D3u)*m32;
         
         dR3v= -(d_3  + (1-g)*alpha_3)*R3v+(theta/(1-g))*S3v +(zeta/(1-h))*C3v + (R1v)*m13 + (R2v)*m23 -(R3v)*m31 - (R3v)*m32 + v*(R2u)*m23 ;
         
         dS3v= -(d_3  + theta/(1-g))*S3v + (1-g)*alpha_3*R3v + rho* epsilon*D3v-(1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v+ (S1v)*m13 + (S2v)*m23 -(S3v)*m31 - (S3v)*m32+ v*(S2u)*m23 ;
         
         dC3v= -(d_3  +(1-eta)*f*phi +(zeta/(1-h)))*C3v + (1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v + (C1v)*m13 + (C2v)*m23 -(C3v)*m31 - (C3v)*m32+ v*(C2u)*m23 ;
         
         dD3v=-(d_3  +rho* epsilon)*D3v +(1-eta)* f*phi*C3v + (D1v)*m13 + (D2v)*m23 -(D3v)*m31 - (D3v)*m32+ v*(D2u)*m23;
          

        
        dN1=dR1u+dS1u+dC1u+dD1u+dR1v+dS1v+dC1v+dD1v;
        
        dN2=dR2u+dS2u+dC2u+dD2u+dR2v+dS2v+dC2v+dD2v;
        
        dN3=dR3u+dS3u+dC3u+dD3u+dR3v+dS3v+dC3v+dD3v;
        
        dC3u.C3v= (N3*(dC3u+dC3v)-(C3u+C3v)*dN3)/(N3)^2;
        dD3u.D3v= (N3*(dD3u+dD3v)-(D3u+D3v)*dN3)/(N3)^2;
        
        dC2u.C2v= (N2*(dC2u+dC2v)-(C2u+C2v)*dN2)/(N2)^2;
        dD2u.D2v= (N2*(dD2u+dD2v)-(D2u+D2v)*dN2)/(N2)^2;
        
        dC1u.C1v= (N1*(dC1u+dC1v)-(C1u+C1v)*dN1)/(N1)^2;
        dD1u.D1v= (N1*(dD1u+dD1v)-(D1u+D1v)*dN1)/(N1)^2;
        dC= (beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u+(1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1v +(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u+(1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v+ (beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))* S3u + (1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v;
        dD = f*phi*C1u + (1-eta)*f*phi*C1v + f*phi*C2u + (1-eta)*f*phi*C2v +f*phi*C3u + (1-eta)*f*phi*C3v; # new cases
        
         list(c(dR1u,dS1u,dC1u,dD1u,dR1v,dS1v,dC1v,dD1v,dR2u,dS2u,dC2u,dD2u,dR2v,dS2v,dC2v,dD2v,dR3u,dS3u,dC3u,dD3u,dR3v,dS3v,dC3v,dD3v,  dN1,dN2,dN3, dC3u.C3v, dD3u.D3v, dC2u.C2v,dD2u.D2v, dC1u.C1v,dD1u.D1v,dC, dD))

 })
}

```






```{r}
mat <- sobol_matrices(N = N, params = params, order = order,type="LHS" )
mat[, "theta"] <- qunif(mat[, "theta"], 0.03, 0.035)
mat[, "zeta"] <- qunif(mat[, "zeta"], 0.03, 0.035)
mat[, "rho"] <- qunif(mat[, "rho"], 0.7, 0.85)
mat[, "epsilon"] <- qunif(mat[, "epsilon"], 0.09, 0.2)
mat[, "phi"] <- qunif(mat[, "phi"], 0.05, 0.07)
mat[, "f"] <- qunif(mat[, "f"], 0.09, 0.2)
mat[, "alpha_1"] <- qunif(mat[, "alpha_1"], 0.0017, 0.021)
mat[, "alpha_2"] <- qunif(mat[, "alpha_2"], 0.27, 0.35)
mat[, "alpha_3"] <- qunif(mat[, "alpha_3"], 0.27, 0.35)
mat[, "beta_1d"] <- qunif(mat[, "beta_1d"], 0.0000047, 0.0000051)
mat[, "beta_2d"] <- qunif(mat[, "beta_2d"], 0.0022, 0.00275)
mat[, "beta_3d"] <- qunif(mat[, "beta_3d"], 0.0032, 0.00375)
mat[, "beta_1c"] <- qunif(mat[, "beta_1c"], 0.00000015, 0.00000016)
mat[, "beta_2c"] <- qunif(mat[, "beta_2c"], 0.000065, 0.000085)
mat[, "beta_3c"] <- qunif(mat[, "beta_3c"], 0.00008, 0.000108)

```





```{r}
d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4



v=0.1

q1=0.92
delta1= 0.0022
q2 =0.75
delta2=0.012
q3 =0.92
delta3=0.1
eta=0
p=0
g=0
h=0




 n.cores <- makeCluster(floor(detectCores() * 0.75))
 registerDoParallel(n.cores)
 y1 <- foreach(i = 1:nrow(mat), .combine = "rbind",
 .packages = "sensobol") %dopar% {
 sobol_ode(d = mat[i, ], times = times, timeOutput = timeOutput,
 state = c(R1u = R1u, S1u = S1u, C1u = C1u, D1u =D1u,
           R1v = 0, S1v = 0, C1v = 0, D1v = 0,
           R2u = R2u, S2u = S2u, C2u = C2u, D2u = D2u,
           R2v = 0, S2v = 0, C2v = 0, D2v = 0,
           R3u = R3u, S3u =S3u, C3u = C3u, D3u = D3u,
           R3v = 0, S3v = 0, C3v = 0, D3v = 0,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u), D= (D1u +D2u + D3u)), func = meta_cdiff)
}

 stopCluster(n.cores)

full.dt1 <- data.table(y1)

indices.dt1 <- melt(full.dt1, measure.vars = c("R1u","S1u","C1u","D1u","R1v","S1v","C1v","D1v","R2u","S2u","C2u","D2u","R2v","S2v","C2v","D2v","R3u","S3u","C3u","D3u","R3v","S3v","C3v","D3v",  "N1","N2","N3", "C3u.C3v", "D3u.D3v", "C2u.C2v","D2u.D2v", "C1u.C1v","D1u.D1v","C","D"))


 

```




```{r}
 p1.dt1<-indices.dt1 %>% filter(variable %in% c("C1u.C1v")) 
 p1.dt2<-indices.dt1 %>% filter(variable %in% c("C2u.C2v")) 
 p1.dt3<-indices.dt1 %>% filter(variable %in% c("C3u.C3v"))
 p1.dt4<-indices.dt1 %>% filter(variable %in% c("D"))
 p1.dt5<-indices.dt1 %>% filter(variable %in% c("C"))
 

ggp_com1<-p1.dt1%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))

ggp_snf1<-p1.dt2%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1)) 

ggp_hos1<-p1.dt3%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))

ggp_accu1<-p1.dt4%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))   

ggp_accu_asy1<-p1.dt5%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))  
 
       prob_plot_com1<- ggplot(ggp_com1, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(c)",  x = "Time (days)", y= "Prevalence of colonized in community" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))
   
 
 prob_plot_snf1<- ggplot(ggp_snf1, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(d)",  x = "Time (days)", y= "Prevalence of colonized in SNF" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))
 
 
 
  prob_plot_hos1<- ggplot(ggp_hos1, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(e)",  x = "Time (days)", y= "Prevalence of colonized in hospital" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1),limits = c(0,0.3), breaks = seq(0, 0.3, 0.1))
 
prob_plot_accu1<- ggplot(ggp_accu1, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(b)",  x = "Time (days)", y= "Cumulative symptomatic cases" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))

prob_plot_accu_asy1<- ggplot(ggp_accu_asy1, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(a)",  x = "Time (days)", y= "Cumulative asymptomatic cases" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 500000), breaks = seq(0, 500000, 150000))+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))



 prob_plot_com1
 
 prob_plot_snf1
 
 prob_plot_hos1
 
 prob_plot_accu1
 
 prob_plot_accu_asy1

```




prob_plot_neq_beta<- plot_grid(prob_plot_accu_asy1,prob_plot_accu1,prob_plot_com1 , prob_plot_snf1, prob_plot_hos1, 
          
          ncol = 2, nrow = 3)
         
   ggsave("uncertainty_neq.png", plot = prob_plot_neq_beta, dpi = 300, width = 10, height = 8)
   


```{r}
 ncpus <- floor(detectCores() * 0.75)
indices1 <- indices.dt1[, sobol_indices(Y = value, N = N, params = params,
 order = order, boot = TRUE, first = "jansen", R = R,
 parallel = "multicore", ncpus = ncpus)$results, .(variable, time)]
```






```{r}
p_D1<-indices1 %>% filter(variable %in% c("D"))
p_c1<-indices1 %>% filter(variable %in% c("C")) 
p_col_com1<-indices1 %>% filter(variable %in% c("C1u.C1v")) 
p_col_snf1<-indices1 %>% filter(variable %in% c("C2u.C2v")) 
p_col_hos1<-indices1 %>% filter(variable %in% c("C3u.C3v")) 
p_dis_com1<-indices1 %>% filter(variable %in% c("D1u.D1v")) 
p_dis_snf1<-indices1 %>% filter(variable %in% c("D2u.D2v")) 
p_dis_hos1<-indices1 %>% filter(variable %in% c("D3u.D3v")) 


Rm_T_D1<-p_D1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_c1<-p_c1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_com1<-p_col_com1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_snf1<-p_col_snf1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_hos1<-p_col_hos1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_com1<-p_dis_com1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_snf1<-p_dis_snf1 %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_hos1<-p_dis_hos1 %>% filter(sensitivity %in% c("Ti")) #total-order indices





gg_D1<-ggplot(Rm_T_D1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order  of cumulative symptomatic cases",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 

gg_D1


gg_c1<-ggplot(Rm_T_c1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of cumulative asymptomatic cases",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 

gg_c1


gg_col_com1<-ggplot(Rm_T_col_com1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of colonized in community ",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.1))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
gg_col_com1


gg_col_snf1<-ggplot(Rm_T_col_snf1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of colonized in SNF",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))
#+ theme(legend.position = "none") 

gg_col_snf1

gg_col_hos1<-ggplot(Rm_T_col_hos1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of colonized in hospital",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")

gg_col_hos1

gg_dis_com1<-ggplot(Rm_T_dis_com1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of diseased in community",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
gg_dis_com1

gg_dis_snf1<-ggplot(Rm_T_dis_snf1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of diseased in SNF",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")

gg_dis_snf1

gg_dis_hos1<-ggplot(Rm_T_dis_hos1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total order of prevalence of diseased in hospital",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 1), breaks = seq(0, 1, 0.2))+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")
gg_dis_hos1

```



```{r}


Rm_S_D1<-p_D1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_c1<-p_c1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_com1<-p_col_com1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_snf1<-p_col_snf1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_hos1<-p_col_hos1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_com1<-p_dis_com1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_snf1<-p_dis_snf1 %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_hos1<-p_dis_hos1 %>% filter(sensitivity %in% c("Si")) #first-order indices





gg_D_S1<-ggplot(Rm_S_D1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order  of cumulative symptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")

gg_D_S1

plot_sen_sym1<- plot_grid(gg_D_S1,gg_D1, ncol = 2, nrow = 1)
         
   ggsave("symto_sen_neq_beta.png", plot = plot_sen_sym1, dpi = 300, width = 8, height = 8)
   



gg_c_S1<-ggplot(Rm_S_c1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of cumulative asymptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))
#+ theme(legend.position = "none")

gg_c_S1

plot_sen_asym1<- plot_grid(gg_c_S1,gg_c1, ncol = 2, nrow = 1)
         
   ggsave("asymto_sen_neq_beta.png", plot = plot_sen_asym1, dpi = 300, width = 8, height = 8)
   
   
   
   
plot_all_cum_neq<-plot_grid(gg_c_S1,gg_c1,gg_D_S1,gg_D1, ncol = 2, nrow = 2)

ggsave("all_sen_neq_beta.png", plot = plot_all_cum_neq, dpi = 300, width = 10, height = 8)







gg_col_com_S1<-ggplot(Rm_S_col_com1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of colonized in community ",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
gg_col_com_S1
#plot_sen_sym1<- plot_grid(gg_D_S1,gg_D1, ncol = 2, nrow = 1)
         
   #ggsave("symto_sen.png", plot = plot_sen_sym1, dpi = 300, width = 10, height = 8)
   

gg_col_snf_S1<-ggplot(Rm_S_col_snf1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of colonized in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))
#+ theme(legend.position = "none") 

gg_col_snf_S1

gg_col_hos_S1<-ggplot(Rm_S_col_hos1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of colonized in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")

gg_col_hos_S1

gg_dis_com_S1<-ggplot(Rm_S_dis_com1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of diseased in community",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
gg_dis_com_S1

gg_dis_snf_S1<-ggplot(Rm_S_dis_snf1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of diseased in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")

gg_dis_snf_S1

gg_dis_hos_S1<-ggplot(Rm_S_dis_hos1, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First order of prevalence of diseased in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125)) 
#+ theme(legend.position = "none")
gg_dis_hos_S1

```




```{r}
Rm_S_D_data_3751<- filter(Rm_S_D1, time ==375)
Rm_T_D_data_3751<- filter(Rm_T_D1, time ==375)

data_sympto1 <- data.frame(
  Category =Rm_S_D_data_3751$parameters ,
  First_order = Rm_S_D_data_3751$original,
  Total_order = Rm_T_D_data_3751$original
)

# Reshape data to long format
data_long1 <- pivot_longer(data_sympto1, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1<-ggplot(data_long1, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the cumulative symptomatic cases", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1

```




```{r}
Rm_S_c_data_3751<- filter(Rm_S_c1, time ==375)
Rm_T_c_data_3751<- filter(Rm_T_c1, time ==375)

data_sympto1 <- data.frame(
  Category =Rm_S_c_data_3751$parameters ,
  First_order = Rm_S_c_data_3751$original,
  Total_order = Rm_T_c_data_3751$original
)

# Reshape data to long format
data_long1 <- pivot_longer(data_sympto1, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_asy_2<-ggplot(data_long1, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the cumulative asymptomatic cases", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_asy_2

```


bar_neq_plot<- plot_grid(bar_neqbetas_asy_2, bar_neqbetas_sym_1, ncol = 1, nrow = 2)

ggsave("bar_neq_plot_asy_sym.png", plot = bar_neq_plot , dpi = 300, width = 10, height = 8)








```{r}
Rm_S_col_com_data_3751<- filter(Rm_S_col_com1, time ==375)
Rm_T_col_com_data_3751<- filter(Rm_T_col_com1, time ==375)

data_sympto1_col_com <- data.frame(
  Category =Rm_S_col_com_data_3751$parameters ,
  First_order = Rm_S_col_com_data_3751$original,
  Total_order = Rm_T_col_com_data_3751$original
)

# Reshape data to long format
data_long1_col_com <- pivot_longer(data_sympto1_col_com, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_col_com<-ggplot(data_long1_col_com, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in community", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_col_com

```


```{r}
Rm_S_col_snf_data_3751<- filter(Rm_S_col_snf1, time ==375)
Rm_T_col_snf_data_3751<- filter(Rm_T_col_snf1, time ==375)

data_sympto1_col_snf <- data.frame(
  Category =Rm_S_col_snf_data_3751$parameters ,
  First_order = Rm_S_col_snf_data_3751$original,
  Total_order = Rm_T_col_snf_data_3751$original
)

# Reshape data to long format
data_long1_col_snf <- pivot_longer(data_sympto1_col_snf, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_col_snf<-ggplot(data_long1_col_snf, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in SNF", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_col_snf
```






```{r}
Rm_S_col_hos_data_3751<- filter(Rm_S_col_hos1, time ==375)
Rm_T_col_hos_data_3751<- filter(Rm_T_col_hos1, time ==375)

data_sympto1_col_hos <- data.frame(
  Category =Rm_S_col_hos_data_3751$parameters ,
  First_order = Rm_S_col_hos_data_3751$original,
  Total_order = Rm_T_col_hos_data_3751$original
)

# Reshape data to long format
data_long1_col_hos <- pivot_longer(data_sympto1_col_hos, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_col_hos<-ggplot(data_long1_col_hos, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in hospital", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_col_hos
```




bar_neq_plot_col<- plot_grid(bar_neqbetas_sym_1_col_com, bar_neqbetas_sym_1_col_snf,bar_neqbetas_sym_1_col_hos, ncol = 1, nrow = 3)

ggsave("bar_neq_plot_col.png", plot = bar_neq_plot_col , dpi = 300, width = 10, height = 8)





```{r}
Rm_S_dis_com_data_3751<- filter(Rm_S_dis_com1, time ==375)
Rm_T_dis_com_data_3751<- filter(Rm_T_dis_com1, time ==375)

data_sympto1_dis_com <- data.frame(
  Category =Rm_S_dis_com_data_3751$parameters ,
  First_order = Rm_S_dis_com_data_3751$original,
  Total_order = Rm_T_dis_com_data_3751$original
)

# Reshape data to long format
data_long1_dis_com <- pivot_longer(data_sympto1_dis_com, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_dis_com<-ggplot(data_long1_dis_com, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in community", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_dis_com

```

```{r}
Rm_S_dis_snf_data_3751<- filter(Rm_S_dis_snf1, time ==375)
Rm_T_dis_snf_data_3751<- filter(Rm_T_dis_snf1, time ==375)

data_sympto1_dis_snf <- data.frame(
  Category =Rm_S_dis_snf_data_3751$parameters ,
  First_order = Rm_S_dis_snf_data_3751$original,
  Total_order = Rm_T_dis_snf_data_3751$original
)

# Reshape data to long format
data_long1_dis_snf <- pivot_longer(data_sympto1_dis_snf, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_dis_snf<-ggplot(data_long1_dis_snf, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in SNF", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_dis_snf
```




```{r}
Rm_S_dis_hos_data_3751<- filter(Rm_S_dis_hos1, time ==375)
Rm_T_dis_hos_data_3751<- filter(Rm_T_dis_hos1, time ==375)

data_sympto1_dis_hos <- data.frame(
  Category =Rm_S_dis_hos_data_3751$parameters ,
  First_order = Rm_S_dis_hos_data_3751$original,
  Total_order = Rm_T_dis_hos_data_3751$original
)

# Reshape data to long format
data_long1_dis_hos <- pivot_longer(data_sympto1_dis_hos, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_neqbetas_sym_1_dis_hos<-ggplot(data_long1_dis_hos, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in hospital", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_neqbetas_sym_1_dis_hos
```




bar_neq_plot_dis<- plot_grid(bar_neqbetas_sym_1_dis_com, bar_neqbetas_sym_1_dis_snf,bar_neqbetas_sym_1_dis_hos, ncol = 1, nrow = 3)

ggsave("bar_neq_plot_dis.png", plot = bar_neq_plot_dis , dpi = 300, width = 10, height = 8)







```{r}



prob_plot_sen_accu1<- plot_grid( gg_col_com_S1,gg_col_com1,gg_col_snf_S1, gg_col_snf1,gg_col_hos_S1,gg_col_hos1, ncol = 2, nrow = 3)
         
ggsave("sen_neq_al1_col.png", plot =prob_plot_sen_accu1 , dpi = 300, width = 11, height = 12)

prob_plot_sen_accu_dis1<- plot_grid( gg_dis_com_S1,gg_dis_com1, gg_dis_snf_S1,gg_dis_snf1,gg_dis_hos_S1,gg_dis_hos1, ncol = 2, nrow = 3)
         
ggsave("sen_neq_all_dis.png", plot =prob_plot_sen_accu_dis1 , dpi = 300, width = 11, height = 12)
```







gg_c<-ggplot(Rm_T_c, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Sensitivity analysis for accumulated cases",  x = "Time (days)", y= "Sobol indices" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 0.7), breaks = seq(0, 0.7, 0.1))+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) 

gg_c

###############equal betas###################


```{r}
mat <- sobol_matrices(N = N, params = params, order = order,type="LHS" )
mat[, "theta"] <- qunif(mat[, "theta"], 0.03, 0.035)
mat[, "zeta"] <- qunif(mat[, "zeta"], 0.03, 0.035)
mat[, "rho"] <- qunif(mat[, "rho"], 0.7, 0.85)
mat[, "epsilon"] <- qunif(mat[, "epsilon"], 0.09, 0.2)
mat[, "phi"] <- qunif(mat[, "phi"], 0.05, 0.07)
mat[, "f"] <- qunif(mat[, "f"], 0.09, 0.2)
mat[, "alpha_1"] <- qunif(mat[, "alpha_1"], 0.0018, 0.02)
mat[, "alpha_2"] <- qunif(mat[, "alpha_2"], 0.27, 0.35)
mat[, "alpha_3"] <- qunif(mat[, "alpha_3"], 0.27, 0.35)
mat[, "beta_1d"] <- qunif(mat[, "beta_1d"], 0.0000004, 0.0000005)
mat[, "beta_2d"] <- qunif(mat[, "beta_2d"], 0.0002, 0.00027)
mat[, "beta_3d"] <- qunif(mat[, "beta_3d"], 0.0002, 0.00027)
mat[, "beta_1c"] <- qunif(mat[, "beta_1c"], 0.0000004, 0.0000005)
mat[, "beta_2c"] <- qunif(mat[, "beta_2c"], 0.0002, 0.00027)
mat[, "beta_3c"] <- qunif(mat[, "beta_3c"], 0.0002, 0.00027)

```



```{r}
d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital





R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4



v=0.1

q1=0.92
delta1= 0.0022
q2 =0.75
delta2=0.012
q3 =0.92
delta3=0.1
eta=0
p=0
g=0
h=0




 n.cores <- makeCluster(floor(detectCores() * 0.75))
 registerDoParallel(n.cores)
 y <- foreach(i = 1:nrow(mat), .combine = "rbind",
 .packages = "sensobol") %dopar% {
 sobol_ode(d = mat[i, ], times = times, timeOutput = timeOutput,
 state = c(R1u = R1u, S1u = S1u, C1u = C1u, D1u =D1u,
           R1v = 0, S1v = 0, C1v = 0, D1v = 0,
           R2u = R2u, S2u = S2u, C2u = C2u, D2u = D2u,
           R2v = 0, S2v = 0, C2v = 0, D2v = 0,
           R3u = R3u, S3u = S3u, C3u = C3u, D3u = D3u,
           R3v = 0, S3v = 0, C3v = 0, D3v = 0,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u), D= (D1u +D2u + D3u)), func = meta_cdiff)
}

 stopCluster(n.cores)

full.dt <- data.table(y)

indices.dt <- melt(full.dt, measure.vars = c("R1u","S1u","C1u","D1u","R1v","S1v","C1v","D1v","R2u","S2u","C2u","D2u","R2v","S2v","C2v","D2v","R3u","S3u","C3u","D3u","R3v","S3v","C3v","D3v",  "N1","N2","N3", "C3u.C3v", "D3u.D3v", "C2u.C2v","D2u.D2v", "C1u.C1v","D1u.D1v","C","D"))
 #print(indices.dt)
```






```{r}
 p.dt1<-indices.dt %>% filter(variable %in% c("C1u.C1v")) 
 p.dt2<-indices.dt %>% filter(variable %in% c("C2u.C2v")) 
 p.dt3<-indices.dt %>% filter(variable %in% c("C3u.C3v"))
 p.dt4<-indices.dt %>% filter(variable %in% c("D"))
 p.dt5<-indices.dt %>% filter(variable %in% c("C"))
 

ggp_com<-p.dt1%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))

ggp_snf<-p.dt2%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1)) 

ggp_hos<-p.dt3%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))

ggp_accu<-p.dt4%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))   

ggp_accu_asy<-p.dt5%>%group_by(time) %>% 
       summarize(median = quantile(value, p = 0.5), q1 = quantile(value, p = .25), q2=quantile(value, p = .75),q3=quantile(value,p=0), q4=quantile(value,p=.15), q5=quantile(value,p=.35),q6=quantile(value,p=.45),q7=quantile(value,p=.55),q8=quantile(value,p=.65),q9=quantile(value,p=.75),q10=quantile(value,p=1))  
 
       prob_plot_com<- ggplot(ggp_com, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(c)",  x = "Time (days)", y= "Prevalence of colonized in community" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1),limits = c(0,0.08), breaks = seq(0, 0.08, 0.02))
   
 
 prob_plot_snf<- ggplot(ggp_snf, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(d)",  x = "Time (days)", y= "Prevalence of colonized in SNF" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1),limits = c(0,0.1), breaks = seq(0, 0.1, 0.025))
 
 
 
  prob_plot_hos<- ggplot(ggp_hos, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(e)",  x = "Time (days)", y= "Prevalence of colonized in hospital" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))+scale_y_continuous(labels=scales::comma_format(scale=1),limits = c(0,0.3), breaks = seq(0, 0.3, 0.1))
 
prob_plot_accu<- ggplot(ggp_accu, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(b)",  x = "Time (days)", y= "Cumulative symptomatic cases" )+theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))

prob_plot_accu_asy<- ggplot(ggp_accu_asy, aes(x=time))  +  geom_ribbon(aes(ymin = q1, ymax=q6,fill = "(25-45)"))+ geom_ribbon(aes(ymin = q6, ymax=median,fill = "(45-50)"))+ geom_ribbon(aes(ymin = median, ymax=q7,fill = "(50-55)"))+ geom_ribbon(aes(ymin = q7, ymax=q9,fill = "(55-75)"))+ geom_line(aes(y=median,colour="Median"),size=1) + scale_colour_manual(name='',values="darkred")+scale_fill_manual(values=c(  "(25-45)"="lightskyblue", "(45-50)"="blue", "(50-55)"="blue", "(55-75)"="lightskyblue"))+ labs(fill="Quantile")+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 10))+ theme(axis.text.x = element_text(face="bold", size=10),
          axis.text.y = element_text(face="bold", size=10)) +labs(title="(a)",  x = "Time (days)", y= "Cumulative asymptomatic cases" )+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(0, 350000), breaks = seq(0, 350000, 100000)) +theme(plot.title = element_text(face="bold",size = 12))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 125))



 prob_plot_com
 
 prob_plot_snf
 
 prob_plot_hos
 
 prob_plot_accu
 
 prob_plot_accu_asy

```

prob_plot_eq_beta<- plot_grid(prob_plot_accu_asy,prob_plot_accu,prob_plot_com , prob_plot_snf, prob_plot_hos, 
          
          ncol = 2, nrow = 3)
         
   ggsave("uncertainty_eq.png", plot = prob_plot_eq_beta, dpi = 300, width = 10, height = 8)
   


```{r}
ncpus <- floor(detectCores() * 0.75)

 indices <- indices.dt[, sobol_indices(Y = value, N = N, params = params,
 order = order, boot = TRUE, first = "jansen", R = R,
 parallel = "multicore", ncpus = ncpus)$results, .(variable, time)]
```




```{r}
p_D<-indices %>% filter(variable %in% c("D"))
p_c<-indices %>% filter(variable %in% c("C")) 
p_col_com<-indices %>% filter(variable %in% c("C1u.C1v")) 
p_col_snf<-indices %>% filter(variable %in% c("C2u.C2v")) 
p_col_hos<-indices %>% filter(variable %in% c("C3u.C3v")) 
p_dis_com<-indices %>% filter(variable %in% c("D1u.D1v")) 
p_dis_snf<-indices %>% filter(variable %in% c("D2u.D2v")) 
p_dis_hos<-indices %>% filter(variable %in% c("D3u.D3v")) 


Rm_T_D<-p_D %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_c<-p_c %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_com<-p_col_com %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_snf<-p_col_snf %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_col_hos<-p_col_hos %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_com<-p_dis_com %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_snf<-p_dis_snf %>% filter(sensitivity %in% c("Ti")) #total-order indices
Rm_T_dis_hos<-p_dis_hos %>% filter(sensitivity %in% c("Ti")) #total-order indices





gg_D<-ggplot(Rm_T_D, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of cumulative symptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))  

gg_D


gg_c<-ggplot(Rm_T_c, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of cumulative asymptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 

gg_c


gg_col_com<-ggplot(Rm_T_col_com, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of prevalence of the colonized in community",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
gg_col_com


gg_col_snf<-ggplot(Rm_T_col_snf, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of prevalence of the colonized in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none") 

gg_col_snf

gg_col_hos<-ggplot(Rm_T_col_hos, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of  prevalence of the colonized in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")

gg_col_hos

gg_dis_com<-ggplot(Rm_T_dis_com, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of prevalence of the diseased in community",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
gg_dis_com

gg_dis_snf<-ggplot(Rm_T_dis_snf, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of prevalence of the diseased in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")

gg_dis_snf

gg_dis_hos<-ggplot(Rm_T_dis_hos, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="Total-order of prevalence of the diseased in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")
gg_dis_hos

```



```{r}


Rm_S_D<-p_D %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_c<-p_c %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_com<-p_col_com %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_snf<-p_col_snf %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_col_hos<-p_col_hos %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_com<-p_dis_com %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_snf<-p_dis_snf %>% filter(sensitivity %in% c("Si")) #first-order indices
Rm_S_dis_hos<-p_dis_hos %>% filter(sensitivity %in% c("Si")) #first-order indices





gg_D_S<-ggplot(Rm_S_D, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of cumulative symptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))    

#+ theme(legend.position = "none")

gg_D_S







gg_c_S<-ggplot(Rm_S_c, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of cumulative asymptomatic cases",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))  
gg_c_S


   
 all_sen_eq_beta<-plot_grid(gg_c_S,gg_c,gg_D_S,gg_D, ncol = 2, nrow = 2)  
 
  ggsave("all_sen_eq_beta.png", plot = all_sen_eq_beta, dpi = 300, width = 10, height = 8)


gg_col_com_S<-ggplot(Rm_S_col_com, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of  prevalence of the colonized in community ",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
gg_col_com


gg_col_snf_S<-ggplot(Rm_S_col_snf, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of prevalence of the colonized in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none") 

gg_col_snf_S

gg_col_hos_S<-ggplot(Rm_S_col_hos, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of prevalence of the colonized in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75)) +scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")

gg_col_hos_S

gg_dis_com_S<-ggplot(Rm_S_dis_com, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of  prevalence of the diseased in community",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))  
gg_dis_com_S

gg_dis_snf_S<-ggplot(Rm_S_dis_snf, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of  prevalence of the diseased in SNF",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2))  
#+ theme(legend.position = "none")

gg_dis_snf_S

gg_dis_hos_S<-ggplot(Rm_S_dis_hos, aes(x=time)) + geom_line(aes(y=original, 
 color = parameters, group = parameters),size=1.25) + guides(color=guide_legend(title="Parameters", override.aes=list(size=1.5)))+scale_colour_manual(values=c("green","blue","red","purple","darkkhaki","black","skyblue", "darkseagreen1","orange","yellow", "cyan", "pink","gray","#5F9EA0","chocolate"))+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(face="bold",size = 12))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14)) +labs(title="First-order of  prevalence of the diseased in hospital",  x = "Time (days)", y= "Sobol indices" )+theme(plot.title = element_text(face="bold",size = 10))+scale_x_continuous(labels=scales::comma_format(scale=1),limits = c(0, 375), breaks = seq(0, 375, 75))+scale_y_continuous(labels=scales::comma_format(scale=1) ,limits = c(-0.1, 1), breaks = seq(-0.1, 1, 0.2)) 
#+ theme(legend.position = "none")
gg_dis_hos_S

```




```{r}



prob_plot_sen_accu1<- plot_grid( gg_col_com_S,gg_col_com1,gg_col_snf_S, gg_col_snf,gg_col_hos_S,gg_col_hos, ncol = 2, nrow = 3)
         
ggsave("sen_eq_al1_col.png", plot =prob_plot_sen_accu1 , dpi = 300, width = 11, height = 12)

prob_plot_sen_accu_dis1<- plot_grid( gg_dis_com_S,gg_dis_com, gg_dis_snf_S,gg_dis_snf,gg_dis_hos_S,gg_dis_hos, ncol = 2, nrow = 3)
         
ggsave("sen_eq_all_dis.png", plot =prob_plot_sen_accu_dis1 , dpi = 300, width = 11, height = 12)
```




```{r}
Rm_S_D_data_375<- filter(Rm_S_D, time ==375)
Rm_T_D_data_375<- filter(Rm_T_D, time ==375)

data_sympto <- data.frame(
  Category =Rm_S_D_data_375$parameters ,
  First_order = Rm_S_D_data_375$original,
  Total_order = Rm_T_D_data_375$original
)

# Reshape data to long format
data_long <- pivot_longer(data_sympto, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_plot_eq_betas_sym<- ggplot(data_long, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the cumulative symptomatic cases", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue"))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+theme(plot.title = element_text(face="bold",size = 12)) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_plot_eq_betas_sym

```


```{r}
Rm_S_c_data_375<- filter(Rm_S_c, time ==375)
Rm_T_c_data_375<- filter(Rm_T_c, time ==375)

data_sympto <- data.frame(
  Category =Rm_S_c_data_375$parameters ,
  First_order = Rm_S_c_data_375$original,
  Total_order = Rm_T_c_data_375$original
)

# Reshape data to long format
data_long <- pivot_longer(data_sympto, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_plot_eq_betas_asy<-ggplot(data_long, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the cumulative asymptomatic cases", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue"))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+theme(plot.title = element_text(face="bold",size = 12)) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_plot_eq_betas_asy

```






bar_eq_plot<- plot_grid(bar_plot_eq_betas_asy, bar_plot_eq_betas_sym, ncol = 1, nrow = 2)

ggsave("bar_eq_betas_asy_sym.png", plot = bar_eq_plot , dpi = 300, width = 10, height = 8)


```{r}
Rm_S_col_com_data_375<- filter(Rm_S_col_com, time ==375)
Rm_T_col_com_data_375<- filter(Rm_T_col_com, time ==375)

data_sympto_col_com <- data.frame(
  Category =Rm_S_col_com_data_375$parameters ,
  First_order = Rm_S_col_com_data_375$original,
  Total_order = Rm_T_col_com_data_375$original
)

# Reshape data to long format
data_long_col_com <- pivot_longer(data_sympto_col_com, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_col_com<-ggplot(data_long_col_com, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in community", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_col_com

```


```{r}
Rm_S_col_snf_data_375<- filter(Rm_S_col_snf, time ==375)
Rm_T_col_snf_data_375<- filter(Rm_T_col_snf, time ==375)

data_sympto_col_snf <- data.frame(
  Category =Rm_S_col_snf_data_375$parameters ,
  First_order = Rm_S_col_snf_data_375$original,
  Total_order = Rm_T_col_snf_data_375$original
)

# Reshape data to long format
data_long_col_snf <- pivot_longer(data_sympto_col_snf, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_col_snf<-ggplot(data_long_col_snf, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in SNF", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_col_snf

```


```{r}
Rm_S_col_hos_data_375<- filter(Rm_S_col_hos, time ==375)
Rm_T_col_hos_data_375<- filter(Rm_T_col_hos, time ==375)

data_sympto_col_hos <- data.frame(
  Category =Rm_S_col_hos_data_375$parameters ,
  First_order = Rm_S_col_hos_data_375$original,
  Total_order = Rm_T_col_hos_data_375$original
)

# Reshape data to long format
data_long_col_hos <- pivot_longer(data_sympto_col_hos, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_col_hos<-ggplot(data_long_col_hos, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the colonized individuals in hospital", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_col_hos

```


bar_eq_plot_col<- plot_grid(bar_eqbetas_sym_col_com, bar_eqbetas_sym_col_snf,bar_eqbetas_sym_col_hos, ncol = 1, nrow = 3)

ggsave("bar_eq_plot_col.png", plot = bar_eq_plot_col , dpi = 300, width = 10, height = 8)



```{r}
Rm_S_dis_com_data_375<- filter(Rm_S_dis_com, time ==375)
Rm_T_dis_com_data_375<- filter(Rm_T_dis_com, time ==375)

data_sympto_dis_com <- data.frame(
  Category =Rm_S_dis_com_data_375$parameters ,
  First_order = Rm_S_dis_com_data_375$original,
  Total_order = Rm_T_dis_com_data_375$original
)

# Reshape data to long format
data_long_dis_com <- pivot_longer(data_sympto_dis_com, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_dis_com<-ggplot(data_long_dis_com, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in community", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_dis_com

```



```{r}
Rm_S_dis_snf_data_375<- filter(Rm_S_dis_snf, time ==375)
Rm_T_dis_snf_data_375<- filter(Rm_T_dis_snf, time ==375)

data_sympto_dis_snf <- data.frame(
  Category =Rm_S_dis_snf_data_375$parameters ,
  First_order = Rm_S_dis_snf_data_375$original,
  Total_order = Rm_T_dis_snf_data_375$original
)

# Reshape data to long format
data_long_dis_snf <- pivot_longer(data_sympto_dis_snf, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_dis_snf<-ggplot(data_long_dis_snf, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in SNF", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_dis_snf

```



```{r}
Rm_S_dis_hos_data_375<- filter(Rm_S_dis_hos, time ==375)
Rm_T_dis_hos_data_375<- filter(Rm_T_dis_hos, time ==375)

data_sympto_dis_hos <- data.frame(
  Category =Rm_S_dis_hos_data_375$parameters ,
  First_order = Rm_S_dis_hos_data_375$original,
  Total_order = Rm_T_dis_hos_data_375$original
)

# Reshape data to long format
data_long_dis_hos <- pivot_longer(data_sympto_dis_hos, cols = starts_with(c("First","Total")), 
                          names_to = "Sobol_indices", values_to = "Value")

# Plot
bar_eqbetas_sym_dis_hos<-ggplot(data_long_dis_hos, aes(x = Category, y = Value, fill = Sobol_indices)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sensitivity analysis of the prevalence of the diseased individuals in hospital", 
       x = "Parameters", y = "Sobol' index") +
  scale_fill_manual(values = c("skyblue", "blue")) +
  theme_minimal()+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+ theme( panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+ theme(axis.text.x = element_text(face="bold", size=11),
          axis.text.y = element_text(face="bold", size=12))

bar_eqbetas_sym_dis_hos

```


bar_eq_plot_dis<- plot_grid(bar_eqbetas_sym_dis_com, bar_eqbetas_sym_dis_snf,bar_eqbetas_sym_dis_hos, ncol = 1, nrow = 3)

ggsave("bar_eq_plot_dis.png", plot = bar_eq_plot_dis , dpi = 300, width = 10, height = 8)











```{r}
library(rlang)
library("reshape2")
library("tidyr")
```



##########################
#Codes for result section
#################

```{r}


d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4

beta1 = 0.000005
beta2 = 0.0027
beta3 = 0.0037


#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225

v=0.1


  times1=seq(0,5625,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
   
   
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.012,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0.5, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0.9, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data = out.data_1%>% select( time)
  data1 = out.data_1$C
  data2 = out.data_5$C
  data3 = out.data_8$C
  data$data1 = data1 
  data$data2 =data2
  data$data3 =data3
  
  plot1= ggplot(data = data, aes(x = time)) +
  geom_line(aes(y = data1, colour = " when h = 0",linetype=" when h = 0" ),size=1.5) +
  geom_line(aes(y = data2, colour = " when h = 0.5",linetype=" when h = 0.5"),size=1.5) +
  geom_line(aes(y = data3, colour = " when h = 0.9",linetype=" when h = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when h = 0", " when h = 0.5", " when h = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when h = 0", " when h = 0.5", " when h = 0.9"),
                     values = c(" when h = 0"=1, " when h = 0.5"=6, " when h = 0.9"=3))

plot_for_h<-plot1+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(a)", x = "Time (years)", y= "Cumulative asymptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 100000), breaks = seq(0, 100000, by = 25000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
  
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0.5, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0.9, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data = out.data_1%>% select( time)
  data1 = out.data_1$C
  data2 = out.data_5$C
  data3 = out.data_8$C
  data$data1 = data1 
  data$data2 =data2
  data$data3 =data3
  
 plot2= ggplot(data = data, aes(x = time)) +
  geom_line(aes(y = data1, colour = " when eta = 0",linetype=" when eta = 0" ),size=1.5) +
  geom_line(aes(y = data2, colour = " when eta = 0.5",linetype=" when eta = 0.5"),size=1.5) +
  geom_line(aes(y = data3, colour = " when eta = 0.9",linetype=" when eta = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when eta = 0", " when eta = 0.5", " when eta = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when eta = 0", " when eta = 0.5", " when eta = 0.9"),
                     values = c(" when eta = 0"=1, " when eta = 0.5"=6, " when eta = 0.9"=3))

plot_for_eta<-plot2+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(b)", x = "Time (years)", y= "Cumulative asymptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 100000), breaks = seq(0, 100000, by = 25000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))





 x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
  
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0.5,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0.9,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data = out.data_1%>% select( time)
  data1 = out.data_1$C
  data2 = out.data_5$C
  data3 = out.data_8$C
  data$data1 = data1 
  data$data2 =data2
  data$data3 =data3
  
 plot3= ggplot(data = data, aes(x = time)) +
  geom_line(aes(y = data1, colour = " when g = 0",linetype=" when g = 0" ),size=1.5) +
  geom_line(aes(y = data2, colour = " when g = 0.5",linetype=" when g = 0.5"),size=1.5) +
  geom_line(aes(y = data3, colour = " when g = 0.9",linetype=" when g = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when g = 0", " when g = 0.5", " when g = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when g = 0", " when g = 0.5", " when g = 0.9"),
                     values = c(" when g = 0"=1, " when g = 0.5"=6, " when g = 0.9"=3))

plot_for_g<-plot3+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(c)", x = "Time (years)", y= "Cumulative asymptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 100000), breaks = seq(0, 100000, by = 25000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  )
 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0.5, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0.9, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,  beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30,   beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data = out.data_1%>% select( time)
  data1 = out.data_1$C
  data2 = out.data_5$C
  data3 = out.data_8$C
  data$data1 = data1 
  data$data2 =data2
  data$data3 =data3
  
  plot4= ggplot(data = data, aes(x = time)) +
  geom_line(aes(y = data1, colour = " when p = 0",linetype=" when p = 0" ),size=1.5) +
  geom_line(aes(y = data2, colour = " when p = 0.5",linetype=" when p = 0.5"),size=1.5) +
  geom_line(aes(y = data3, colour = " when p = 0.9",linetype=" when p = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when p = 0", " when p = 0.5", " when p = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when p = 0", " when p = 0.5", " when p = 0.9"),
                     values = c(" when p = 0"=1, " when p = 0.5"=6, " when p = 0.9"=3))

plot_for_p<-plot4+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(d)", x = "Time (years)", y= "Cumulative asymptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 100000), breaks = seq(0, 100000, by = 25000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


prob_plot_for_prev<- plot_grid(plot_for_h,plot_for_eta,plot_for_g,plot_for_p,
          
          ncol = 2, nrow = 2)
         
   ggsave("prob_plot_prev.png", plot = prob_plot_for_prev, dpi = 300, width = 10, height = 8)

```




```{r}
d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4

beta1 = 0.000005#0.000005
beta2 = 0.0027
beta3 = 0.0037


#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225

v=0.1


  times1=seq(0,5625,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
   
   
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0.5, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0.9, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  


  data_D = out.data_1%>% select( time)
  data1_D = out.data_1$D
  data2_D = out.data_5$D
  data3_D = out.data_8$D
  data_D$data1_D = data1_D 
  data_D$data2_D =data2_D
  data_D$data3_D =data3_D
  
  plot1_D= ggplot(data = data_D, aes(x = time)) +
  geom_line(aes(y = data1_D, colour = " when h = 0",linetype=" when h = 0" ),size=1.5) +
  geom_line(aes(y = data2_D, colour = " when h = 0.5",linetype=" when h = 0.5"),size=1.5) +
  geom_line(aes(y = data3_D, colour = " when h = 0.9",linetype=" when h = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when h = 0", " when h = 0.5", " when h = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when h = 0", " when h = 0.5", " when h = 0.9"),
                     values = c(" when h = 0"=1, " when h = 0.5"=6, " when h = 0.9"=3))

plot_for_h_D<-plot1_D+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(a)", x = "Time (years)", y= "Cumulative symptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 12000), breaks = seq(0, 12000, by = 2000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
  
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0.5, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0.9, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data_D = out.data_1%>% select( time)
  data1_D = out.data_1$D
  data2_D = out.data_5$D
  data3_D = out.data_8$D
  data_D$data1_D = data1_D 
  data_D$data2_D =data2_D
  data_D$data3_D =data3_D
  
 plot2_D= ggplot(data = data_D, aes(x = time)) +
  geom_line(aes(y = data1_D, colour = " when eta = 0",linetype=" when eta = 0" ),size=1.5) +
  geom_line(aes(y = data2_D, colour = " when eta = 0.5",linetype=" when eta = 0.5"),size=1.5) +
  geom_line(aes(y = data3_D, colour = " when eta = 0.9",linetype=" when eta = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when eta = 0", " when eta = 0.5", " when eta = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when eta = 0", " when eta = 0.5", " when eta = 0.9"),
                     values = c(" when eta = 0"=1, " when eta = 0.5"=6, " when eta = 0.9"=3))

plot_for_eta_D<-plot2_D+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(b)", x = "Time (years)", y= "Cumulative symptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 12000), breaks = seq(0, 12000, by = 2000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))





 x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  ) 
  
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0.5,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0.9,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data_D = out.data_1%>% select( time)
  data1_D = out.data_1$D
  data2_D = out.data_5$D
  data3_D = out.data_8$D
  data_D$data1_D = data1_D 
  data_D$data2_D =data2_D
  data_D$data3_D =data3_D
  
 plot3_D= ggplot(data = data_D, aes(x = time)) +
  geom_line(aes(y = data1_D, colour = " when g = 0",linetype=" when g = 0" ),size=1.5) +
  geom_line(aes(y = data2_D, colour = " when g = 0.5",linetype=" when g = 0.5"),size=1.5) +
  geom_line(aes(y = data3_D, colour = " when g = 0.9",linetype=" when g = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when g = 0", " when g = 0.5", " when g = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when g = 0", " when g = 0.5", " when g = 0.9"),
                     values = c(" when g = 0"=1, " when g = 0.5"=6, " when g = 0.9"=3))

plot_for_g_D<-plot3_D+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(c)", x = "Time (years)", y= "Cumulative symptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 12000), breaks = seq(0, 12000, by = 2000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u),C= (C1u +C2u + C3u),D= (D1u +D2u + D3u)
  )
  
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  
  parms_5=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0.5, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_5 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_5))
  
   parms_8=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0.9, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_8 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_8))
  
  data_D = out.data_1%>% select( time)
  data1_D = out.data_1$D
  data2_D = out.data_5$D
  data3_D = out.data_8$D
  data_D$data1_D = data1_D 
  data_D$data2_D =data2_D
  data_D$data3_D =data3_D
  
  plot4_D= ggplot(data = data_D, aes(x = time)) +
  geom_line(aes(y = data1_D, colour = " when p = 0",linetype=" when p = 0" ),size=1.5) +
  geom_line(aes(y = data2_D, colour = " when p = 0.5",linetype=" when p = 0.5"),size=1.5) +
  geom_line(aes(y = data3_D, colour = " when p = 0.9",linetype=" when p = 0.9"),size=1.5)  + 
  scale_colour_manual("vaccine efficacy", 
                      breaks = c(" when p = 0", " when p = 0.5", " when p = 0.9"),
                      values = c("red", "green", "blue")) +   
  scale_linetype_manual(
                     breaks = c(" when p = 0", " when p = 0.5", " when p = 0.9"),
                     values = c(" when p = 0"=1, " when p = 0.5"=6, " when p = 0.9"=3))

plot_for_p_D<-plot4_D+theme_minimal()+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 14))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ labs(title="(d)", x = "Time (years)", y= "Cumulative symptomatic cases", linetype="vaccine efficacy", colour="vaccine efficacy") + 
  scale_y_continuous(labels=scales::comma_format(scale=1),limits=c(0, 12000), breaks = seq(0, 12000, by = 2000))+ 
  scale_x_continuous(labels=c("1","5","10","15") ,limits=c(0, 5625), breaks = c(365, 5*365, 10*365,15*365))


prob_plot_for_prev_D<- plot_grid(plot_for_h_D,plot_for_eta_D,plot_for_g_D,plot_for_p_D,
          
          ncol = 2, nrow = 2)
         
   ggsave("prob_plot_prev_D.png", plot = prob_plot_for_prev_D, dpi = 300, width = 10, height = 8)

```







##########################################################

```{r}
meta_cdiff <- function(t, state, parameters) {
 with(as.list(c(state, parameters)), {
          N1 = R1u +S1u+ C1u+ D1u+ R1v+ S1v+C1v+D1v;
          N2 = R2u +S2u+ C2u+ D2u+ R2v+ S2v+C2v+D2v;
          N3 = R3u +S3u+ C3u+ D3u+ R3v+ S3v+C3v+D3v;
         
         d_2N2 = d_2*(R2u +S2u+ C2u+ D2u+ R2v+ S2v+C2v+D2v);
         d_1N1 = d_1*(R1u +S1u+ C1u+ D1u+ R1v+ S1v+C1v+D1v);
         d_3N3 = d_3*(R3u +S3u+ C3u+ D3u+ R3v+ S3v+C3v+D3v);
         
         b = d_1N1 + d_2N2 + d_3N3 ;
         
         m12= (1-N2/K2)*(1-q1)*delta1;
         m21= q2*delta2 + (N3/K3)*(1-q2)*delta2;
         m13= (1-N3/K3)*q1*delta1;
         m31= q3*delta3 + (N2/K2)*(1-q3)*delta3;
         m23= (1-N3/K3)*(1-q2)*delta2;
         m32= (1-N2/K2)*(1-q3)*delta3;
        
         
        dR1u= b-alpha_1*R1u-d_1*R1u+theta*S1u+zeta*C1u+(1-v)*(R2u)*m21+(1-v)*(R3u)*m31- (R1u)*m12  -(R1u)*m13 ;
         
         dS1u= -d_1*S1u -theta*S1u+ alpha_1*R1u + rho* epsilon*D1u-(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u +(1-v)*(S2u)*m21 + (1-v)*(S3u)*m31- (S1u)*m12  -(S1u)*m13;
         
         dC1u= -(d_1+f*phi+zeta)*C1u+(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u+(1-v)*(C2u)*m21+(1-v)*(C3u)*m31- (C1u)*m12  -(C1u)*m13; 
         
         dD1u=-(d_1+rho*epsilon)*D1u+f*phi*C1u +(1-v)*(D2u)*m21+(1-v)*(D3u)*m31- (D1u)*m12 -(D1u)*m13;
         
         dR1v=-(1-g)* alpha_1*R1v - d_1* R1v+ (theta/(1-g))*S1v + (zeta/(1-h))*C1v + (R2v)*m21+(R3v)*m31- (R1v)*m12  -(R1v)*m13 + v*(R2u)*m21+ v*(R3u)*m31;
         
         dS1v= -(d_1+ theta/(1-g))*S1v+(1-g)*alpha_1*R1v+rho*epsilon*D1v-(1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))* S1v + (S2v)*m21+(S3v)*m31- (S1v)*m12  -(S1v)*m13 + v*(S2u)*m21+ v*(S3u)*m31;
         
         dC1v=  -(d_1+(1-eta)*f*phi+(zeta/(1-h)))*C1v+
    (1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1v + (C2v)*m21+(C3v)*m31- (C1v)*m12  -(C1v)*m13 + v*(C2u)*m21+ v*(C3u)*m31;
         
         dD1v= -(d_1 + rho* epsilon)*D1v+(1-eta)*f*phi*C1v + (D2v)*m21+(D3v)*m31- (D1v)*m12  -(D1v)*m13 + v*(D2u)*m21 + v*(D3u)*m31; 
         
    #nursinh home
         
         dR2u= -alpha_2*R2u-d_2*R2u+ theta*S2u + zeta*C2u + (R1u)*m12 + (1-v)*(R3u)*m32- (R2u)*m23 - (R2u)*m21;
         
         dS2u= -(d_2+theta)*S2u+alpha_2*R2u+rho*epsilon*D2u-(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u + (S1u)*m12+(1-v)*(S3u)*m32 -(S2u)*m23 - (S2u)*m21;
         
         dC2u= -(d_2+f*phi+zeta)*C2u+(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u+(C1u)*m12+
           (1-v)*(C3u)*m32- (C2u)*m23 - (C2u)*m21;
         
         dD2u= -(d_2+rho*epsilon)*D2u +f*phi*C2u + (D1u)*m12+(1-v)*(D3u)*m32- (D2u)*m23 - (D2u)*m21;
         
         
         dR2v= -(1-g)*alpha_2*R2v-d_2*R2v+(theta/(1-g))*S2v+(zeta/(1-h))*C2v + (R1v)*m12+(R3v)*m32- (R2v)*m23 - (R2v)*m21 + v*(R3u)*m32; 
         
         dS2v= -(d_2+ theta/(1-g))*S2v +(1-g)* alpha_2*R2v + rho* epsilon*D2v-(1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v +(S1v)*m12+(S3v)*m32- (S2v)*m23 - (S2v)*m21+v*(S3u)*m32; 
         
         dC2v= -(d_2+(1-eta)*f*phi+(zeta/(1-h)))*C2v + (1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v+
           ( C1v)*m12+(C3v)*m32- (C2v)*m23 - (C2v)*m21 +v*(C3u)*m32;  
         
         dD2v= -(d_2 + rho* epsilon)*D2v +(1-eta)*f*phi*C2v + (D1v)*m12+(D3v)*m32- (D2v)*m23 - (D2v)*m21 +v*(D3u)*m32; 
   #hospital  
         
         dR3u= -(d_3  + alpha_3)*R3u +theta*S3u + zeta*C3u + (R1u)*m13 + (1-v)*(R2u)*m23 -(R3u)*m31 - (R3u)*m32;
         
         dS3u= -(d_3  + theta)*S3u + alpha_3*R3u + rho* epsilon*D3u- (beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3u + (S1u)*m13 + (1-v)*(S2u)*m23 -(S3u)*m31 - (S3u)*m32;
         
         dC3u= -(d_3+f*phi+zeta)*C3u+(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))* S3u + (C1u)*m13 + (1-v)*(C2u)*m23 -(C3u)*m31 - (C3u)*m32;
         
         dD3u= -(d_3  +rho* epsilon)*D3u + f*phi*C3u + (D1u)*m13 + (1-v)*(D2u)*m23 -(D3u)*m31 - (D3u)*m32;
         
         dR3v= -(d_3  + (1-g)*alpha_3)*R3v+(theta/(1-g))*S3v +(zeta/(1-h))*C3v + (R1v)*m13 + (R2v)*m23 -(R3v)*m31 - (R3v)*m32 + v*(R2u)*m23 ;
         
         dS3v= -(d_3  + theta/(1-g))*S3v + (1-g)*alpha_3*R3v + rho* epsilon*D3v-(1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v+ (S1v)*m13 + (S2v)*m23 -(S3v)*m31 - (S3v)*m32+ v*(S2u)*m23 ;
         
         dC3v= -(d_3  +(1-eta)*f*phi +(zeta/(1-h)))*C3v + (1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v + (C1v)*m13 + (C2v)*m23 -(C3v)*m31 - (C3v)*m32+ v*(C2u)*m23 ;
         
         dD3v=-(d_3  +rho* epsilon)*D3v +(1-eta)* f*phi*C3v + (D1v)*m13 + (D2v)*m23 -(D3v)*m31 - (D3v)*m32+ v*(D2u)*m23;
          

        
        dN1=dR1u+dS1u+dC1u+dD1u+dR1v+dS1v+dC1v+dD1v;
        
        dN2=dR2u+dS2u+dC2u+dD2u+dR2v+dS2v+dC2v+dD2v;
        
        dN3=dR3u+dS3u+dC3u+dD3u+dR3v+dS3v+dC3v+dD3v;
        
        dC3u.C3v= (N3*(dC3u+dC3v)-(C3u+C3v)*dN3)/(N3)^2;
        dD3u.D3v= (N3*(dD3u+dD3v)-(D3u+D3v)*dN3)/(N3)^2;
        
        dC2u.C2v= (N2*(dC2u+dC2v)-(C2u+C2v)*dN2)/(N2)^2;
        dD2u.D2v= (N2*(dD2u+dD2v)-(D2u+D2v)*dN2)/(N2)^2;
        
        dC1u.C1v= (N1*(dC1u+dC1v)-(C1u+C1v)*dN1)/(N1)^2;
        dD1u.D1v= (N1*(dD1u+dD1v)-(D1u+D1v)*dN1)/(N1)^2;
        dC= (beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1u+(1-p)*(beta_1c*(C1u+C1v)+beta_1d*(D1u+D1v))*S1v +(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2u+(1-p)*(beta_2c*(C2u+C2v)+beta_2d*(D2u+D2v))*S2v+ (beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))* S3u + (1-p)*(beta_3c*(C3u+C3v)+beta_3d*(D3u+D3v))*S3v;
        dD = f*phi*C1u + (1-eta)*f*phi*C1v + f*phi*C2u + (1-eta)*f*phi*C2v +f*phi*C3u + (1-eta)*f*phi*C3v; 
        dP_tot= ((N1+N2+N3)*(dC1u+dC1v+dC2u+dC2v+dC3u+dC3v)-(C1u+C1v+C2u+C2v+C3u+C3v)*(dN1+dN2+dN3))/(N1+N2+N3)^2;
        dP_dis= ((N1+N2+N3)*(dD1u+dD1v+dD2u+dD2v+dD3u+dD3v)-(D1u+D1v+D2u+D2v+D3u+D3v)*(dN1+dN2+dN3))/(N1+N2+N3)^2;
         list(c(dR1u,dS1u,dC1u,dD1u,dR1v,dS1v,dC1v,dD1v,dR2u,dS2u,dC2u,dD2u,dR2v,dS2v,dC2v,dD2v,dR3u,dS3u,dC3u,dD3u,dR3v,dS3v,dC3v,dD3v,  dN1,dN2,dN3, dC3u.C3v, dD3u.D3v, dC2u.C2v,dD2u.D2v, dC1u.C1v,dD1u.D1v,dC, dD,dP_tot,dP_dis))

 })
}
```

###For diseased

```{r}
library("reshape2")
library("tidyr")
library(lubridate)
library(tidyverse)

d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


beta1 = 0.000005
beta2 = 0.0027
beta3 = 0.0037



#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225


v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u), D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$D3u.D3v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$D3u.D3v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$D3u.D3v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$D3u.D3v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$D3u.D3v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$D3u.D3v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$D3u.D3v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$D3u.D3v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$D3u.D3v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$D3u.D3v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$D3u.D3v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$D3u.D3v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(c)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of diseased in hospital",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))

scientific_10 <- function(x) {
  parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}


plot_dis_hos<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)

plot_dis_hos

```



```{r}


d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4

beta1 = 0.000005
beta2 = 0.0027
beta3 = 0.0037



#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             N1 = R1u+S1u+C1u+D1u, N2 = R2u+S2u+C2u+D2u,  N3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$D2u.D2v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$D2u.D2v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$D2u.D2v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$D2u.D2v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$D2u.D2v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$D2u.D2v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$D2u.D2v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$D2u.D2v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$D2u.D2v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$D2u.D2v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$D2u.D2v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$D2u.D2v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(b)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of diseased in SNF",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_dis_snf<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16)) + theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)


plot_dis_snf

```

```{r}


d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


beta1 = 0.000005
beta2 = 0.0027
beta3 = 0.0037



#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$D1u.D1v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$D1u.D1v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$D1u.D1v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$D1u.D1v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$D1u.D1v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$D1u.D1v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$D1u.D1v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$D1u.D1v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$D1u.D1v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$D1u.D1v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$D1u.D1v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$D1u.D1v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(a)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of diseased in community",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_dis_com<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)

plot_dis_com

```


```{r}


d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


beta1 = 0.000005
beta2 = 0.0027
beta3 = 0.0037



#beta1 = 0.00000045
#beta2 = 0.00024
#beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u), D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1/30,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2/30,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3/30, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$P_dis
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$P_dis
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$P_dis
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$P_dis
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$P_dis
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$P_dis
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$P_dis
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$P_dis
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$P_dis
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$P_dis
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$P_dis
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$P_dis
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(d)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of diseased in meta-population",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_dis_meta<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)
plot_dis_meta
```


```{r}
prev_plot_for_dis<- plot_grid(plot_dis_com, plot_dis_snf,plot_dis_hos,plot_dis_meta,
          
          ncol = 2, nrow = 2)
         
   ggsave("prev_dis_prev.png", plot = prev_plot_for_dis, dpi = 300, width = 10, height = 8)
```



###For colonized###
```{r}




d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


#beta1 = 0.000005
#beta2 = 0.0027
#beta3 = 0.0037



beta1 = 0.00000045
beta2 = 0.00024
beta3 = 0.000225

v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$C3u.C3v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$C3u.C3v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$C3u.C3v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$C3u.C3v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$C3u.C3v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$C3u.C3v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$C3u.C3v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$C3u.C3v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$C3u.C3v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$C3u.C3v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$C3u.C3v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$C3u.C3v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(c)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of colonized in hospital",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_col_hos<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))

plot_col_hos

```



```{r}




d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


#beta1 = 0.000005
#beta2 = 0.0027
#beta3 = 0.0037



beta1 = 0.00000045
beta2 = 0.00024
beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2, beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3,  beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$C2u.C2v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$C2u.C2v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$C2u.C2v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$C2u.C2v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$C2u.C2v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$C2u.C2v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$C2u.C2v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$C2u.C2v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$C2u.C2v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$C2u.C2v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$C2u.C2v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$C2u.C2v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(b)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of colonized in SNF",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_col_snf<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))

plot_col_snf

```





```{r}




d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4

#beta1 = 0.000005
#beta2 = 0.0027
#beta3 = 0.0037



beta1 = 0.00000045
beta2 = 0.00024
beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$C1u.C1v
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$C1u.C1v
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$C1u.C1v
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$C1u.C1v
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$C1u.C1v
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$C1u.C1v
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$C1u.C1v
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$C1u.C1v
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$C1u.C1v
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$C1u.C1v
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$C1u.C1v
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$C1u.C1v
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(a)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of colonized in community",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_col_com<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 16)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=14))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)

plot_col_com

```





```{r}




d_1 <- 1/(78.5*365)
d_2 <- 0.01 #nursing home data
d_3 <- 0.02 #clostridium data
K2<- 200 # maximum carrying capacity of nursing home
K3<- 1260 # maximum carrying capacity of hospital

R1u=63154
S1u=236378
C1u=3838
D1u=291
R2u=34
S2u=110
C2u=15
D2u=1
R3u=204
S3u=671
C3u=121
D3u=4


#beta1 = 0.000005
#beta2 = 0.0027
#beta3 = 0.0037



beta1 = 0.00000045
beta2 = 0.00024
beta3 = 0.000225
v=0.1
vaccine_efficacy = c(0, 0.1, 0.2,0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9)
Prev_vector <- numeric(0)
Prev_vector2 <- numeric(0)
Prev_vector3 <- numeric(0)
Prev_vector4 <- numeric(0)

Prev_vector5 <- numeric(0)
Prev_vector6 <- numeric(0)
Prev_vector7 <- numeric(0)
Prev_vector8 <- numeric(0)

Prev_vector9 <- numeric(0)
Prev_vector10 <- numeric(0)
Prev_vector11 <- numeric(0)
Prev_vector12 <- numeric(0)

for (i in vaccine_efficacy){


  times1=seq(0,90,1)
  times2=seq(0,366*1,1)
  times3=seq(0,366*15,1)
  
  x01=c(R1u = (1-v)*R1u, S1u = (1-v)*S1u, C1u = (1-v)*C1u, D1u =(1-v)*D1u,
           R1v = v*R1u, S1v = v*S1u, C1v = v*C1u, D1v = v*D1u,
           R2u = (1-v)*R2u, S2u = (1-v)*S2u, C2u = (1-v)*C2u, D2u = (1-v)*D2u,
           R2v = v*R2u, S2v = v*S2u, C2v = v*C2u, D2v = v*D2u,
           R3u = (1-v)*R3u, S3u =(1-v)*S3u, C3u = (1-v)*C3u, D3u = (1-v)*D3u,
           R3v = v*R3u, S3v = v*S3u, C3v = v*C3u, D3v = v*D3u,
             n1 = R1u+S1u+C1u+D1u, n2 = R2u+S2u+C2u+D2u,  n3 = R3u+S3u+C3u+D3u, 
        C3u.C3v= C3u/(R3u+S3u+C3u+D3u), D3u.D3v= D3u/(R3u+S3u+C3u+D3u),  C2u.C2v= C2u/(R2u+S2u+C2u+D2u),
        D2u.D2v= D2u/(R2u+S2u+C2u+D2u), C1u.C1v= C1u/(R1u+S1u+C1u+D1u), D1u.D1v= D1u/(R1u+S1u+C1u+D1u), C= (C1u +C2u + C3u),D=(D1u+D2u+D3u), P_tot=(C1u+C2u+C3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u),P_dis=(D1u+D2u+D3u)/(R1u+S1u+C1u+D1u+R2u+S2u+C2u+D2u+R3u+S3u+C3u+D3u)
  ) 
  parms_0=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= i, g=0,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_2=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=i,  p=0, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_3=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=i, h=0, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  parms_4=c(  d_1 = d_1, d_2 = d_2, d_3= d_3, K2=K2, K3= K3, q1=0.92, delta1= 0.0022,q2 =0.75,delta2=0.02,q3 =0.92, delta3=0.1, f = 0.1, eta= 0, g=0,  p=0, h=i, theta=0.033,zeta=0.033, rho= 0.8, epsilon=0.1,phi = 0.06, v=v,
            
            alpha_1=0.0019,  beta_1c=beta1,  beta_1d =beta1, 
            alpha_2= 0.32,  beta_2c= beta2,beta_2d = beta2,
            alpha_3=0.32,  beta_3c= beta3, beta_3d = beta3)
  
  out.data_1 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_0))
  out.data_2 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_2))
  out.data_3 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_3))
  out.data_4 = as.data.frame(lsoda(x01, times1, meta_cdiff , parms_4))
  
  
  out.data_5 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_0))
  out.data_6 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_2))
  out.data_7 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_3))
  out.data_8 = as.data.frame(lsoda(x01, times2, meta_cdiff , parms_4))
  
  
  out.data_9 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_0))
  out.data_10 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_2))
  out.data_11 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_3))
  out.data_12 = as.data.frame(lsoda(x01, times3, meta_cdiff , parms_4))
  
 prev<- out.data_1$P_tot
 last_element <- prev[length(prev)]
 Prev_vector<- append(Prev_vector, last_element)
 
 prev2<- out.data_2$P_tot
 last_element2 <- prev2[length(prev2)]
 Prev_vector2<- append(Prev_vector2, last_element2)
 
  prev3<- out.data_3$P_tot
 last_element3 <- prev3[length(prev3)]
 Prev_vector3<- append(Prev_vector3, last_element3)
 
 prev4<- out.data_4$P_tot
 last_element4 <- prev4[length(prev4)]
 Prev_vector4<- append(Prev_vector4, last_element4)
 
 
 prev5<- out.data_5$P_tot
 last_element5 <- prev5[length(prev5)]
 Prev_vector5<- append(Prev_vector5, last_element5)
 
 prev6<- out.data_6$P_tot
 last_element6 <- prev6[length(prev6)]
 Prev_vector6<- append(Prev_vector6, last_element6)
 
  prev7<- out.data_7$P_tot
 last_element7 <- prev7[length(prev7)]
 Prev_vector7<- append(Prev_vector7, last_element7)
 
 prev8<- out.data_8$P_tot
 last_element8 <- prev8[length(prev8)]
 Prev_vector8<- append(Prev_vector8, last_element8)
 
 
  prev9<- out.data_9$P_tot
 last_element9 <- prev9[length(prev9)]
 Prev_vector9<- append(Prev_vector9, last_element9)
 
 prev10<- out.data_10$P_tot
 last_element10 <- prev10[length(prev10)]
 Prev_vector10<- append(Prev_vector10, last_element10)
 
  prev11<- out.data_11$P_tot
 last_element11 <- prev11[length(prev11)]
 Prev_vector11<- append(Prev_vector11, last_element11)
 
 prev12<- out.data_12$P_tot
 last_element12 <- prev12[length(prev12)]
 Prev_vector12<- append(Prev_vector12, last_element12)
 
 
}


plot = as.data.frame(vaccine_efficacy)
plot$eta_vary1=Prev_vector
plot$g_vary1 = Prev_vector2
plot$p_vary1=Prev_vector3
plot$h_vary1 = Prev_vector4



plot$eta_vary2=Prev_vector5
plot$g_vary2 = Prev_vector6
plot$p_vary2=Prev_vector7
plot$h_vary2 = Prev_vector8

plot$eta_vary3=Prev_vector9
plot$g_vary3 = Prev_vector10
plot$p_vary3=Prev_vector11
plot$h_vary3 = Prev_vector12

plot1= ggplot(data = plot, aes(x = vaccine_efficacy)) +
    geom_line(aes(y = eta_vary2, colour = "at 1 year with varying eta",linetype = "at 1 year with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary2, colour = "at 1 year with varying g",linetype = "at 1 year with varying g"),size=1.5) +
  geom_line(aes(y = p_vary2, colour = "at 1 year with varying p",linetype = "at 1 year with varying p"),size=1.5)+
  geom_line(aes(y = h_vary2, colour = "at 1 year with varying h",linetype = "at 1 year with varying h"),size=1.5)+
  geom_line(aes(y = eta_vary3, colour = "at 15 years with varying eta",linetype = "at 15 years with varying eta"),size=1.5) +
  geom_line(aes(y = g_vary3, colour = "at 15 years with varying g",linetype = "at 15 years with varying g"),size=1.5) +
  geom_line(aes(y = p_vary3, colour = "at 15 years with varying p",linetype = "at 15 years with varying p"),size=1.5)+
  geom_line(aes(y = h_vary3, colour = "at 15 years with varying h",linetype = "at 15 years with varying h"),size=1.5)+
    labs(title = "(d)", x = "Vaccine efficacy(eta,g,p,h)", y= "Prevalence of colonized in meta-population",linetype = "Prevalence",
         colour = "Prevalence") + 
  scale_colour_manual("Prevalence", 
                      breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),  values = c("red", "green", "blue","purple","red", "green", "blue","purple","red", "green", "blue","purple")) +   
  scale_linetype_manual(
                     breaks = c("at 1 year with varying eta", "at 1 year with varying g", "at 1 year with varying p","at 1 year with varying h","at 15 years with varying eta", "at 15 years with varying g", "at 15 years with varying p","at 15 years with varying h"),
                     values = c("at 1 year with varying eta"=1,"at 1 year with varying g"=1,"at 1 year with varying p"=1,"at 1 year with varying h"=1,"at 15 years with varying eta"=3,"at 15 years with varying g"=3,"at 15 years with varying p"=3,"at 15 years with varying h"=3))


plot_col_meta<-plot1+theme_bw() + theme( panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))+theme(axis.title = element_text(size = 14)) +theme(plot.title = element_text(size = 16))+ theme(axis.text.x = element_text(face="bold", size=14),
          axis.text.y = element_text(face="bold", size=12))+ 
  scale_x_continuous(breaks = seq(0, 1, by = 0.3))+  scale_y_continuous(label=scientific_10)

plot_col_meta

```





```{r}
prev_plot_for_col<- plot_grid(plot_col_com,plot_col_snf,plot_col_hos,plot_col_meta,
          
          ncol = 2, nrow = 2)
         
   ggsave("prev_col_prev1.png", plot = prev_plot_for_col, dpi = 300, width = 10, height = 8)
```



